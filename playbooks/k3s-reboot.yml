---
# Playbook: Reboot k3s cluster nodes safely
# Usage: ansible-playbook k3s-reboot.yml
#
# This playbook performs graceful reboots of k3s cluster nodes with proper
# workload orchestration (cordon, drain, reboot, uncordon) to maintain
# cluster availability during reboots.
#
# Requirements:
# - kubectl configured on bastion (k3s-bastion-01)
#
# Use this after system updates that require reboots.

- name: Reboot k3s Cluster Nodes
  hosts: k3s_cluster
  gather_facts: false
  become: true
  serial: 1  # Reboot one node at a time to maintain cluster availability

  vars:
    # Kubeconfig path on bastion
    kubeconfig_path: /home/ubuntu/.kube/config
    # Drain timeout (how long to wait for pods to terminate gracefully)
    drain_timeout: 300s

  tasks:
    - name: Check if reboot is required
      ansible.builtin.stat:
        path: /var/run/reboot-required
      register: reboot_required_file
      tags:
        - reboot
        - check

    - name: Display reboot status
      ansible.builtin.debug:
        msg: "{{ inventory_hostname }}: Reboot {{ 'REQUIRED' if reboot_required_file.stat.exists else 'NOT REQUIRED' }}"
      tags:
        - reboot
        - check

    - name: Cordon node (mark unschedulable)
      ansible.builtin.command:
        cmd: kubectl cordon {{ inventory_hostname }}
      delegate_to: k3s-bastion-01
      environment:
        KUBECONFIG: "{{ kubeconfig_path }}"
      when: reboot_required_file.stat.exists
      changed_when: true
      tags:
        - reboot
        - drain

    - name: Drain node (evict pods)
      ansible.builtin.command:
        cmd: kubectl drain {{ inventory_hostname }} --ignore-daemonsets --delete-emptydir-data --timeout={{ drain_timeout }}
      delegate_to: k3s-bastion-01
      environment:
        KUBECONFIG: "{{ kubeconfig_path }}"
      when: reboot_required_file.stat.exists
      changed_when: true
      tags:
        - reboot
        - drain

    - name: Reboot the node
      ansible.builtin.reboot:
        reboot_timeout: 600
        msg: "Rebooting {{ inventory_hostname }} for system updates"
        pre_reboot_delay: 5
        post_reboot_delay: 30
      when: reboot_required_file.stat.exists
      tags:
        - reboot

    - name: Wait for node to come back online
      ansible.builtin.wait_for_connection:
        timeout: 300
        delay: 10
      when: reboot_required_file.stat.exists
      tags:
        - reboot

    - name: Verify node is responsive
      ansible.builtin.ping:
      when: reboot_required_file.stat.exists
      tags:
        - reboot

    - name: Uncordon node (mark schedulable)
      ansible.builtin.command:
        cmd: kubectl uncordon {{ inventory_hostname }}
      delegate_to: k3s-bastion-01
      environment:
        KUBECONFIG: "{{ kubeconfig_path }}"
      when: reboot_required_file.stat.exists
      changed_when: true
      tags:
        - reboot
        - uncordon

    - name: Wait for node to be ready in cluster
      ansible.builtin.command:
        cmd: kubectl get node {{ inventory_hostname }} -o jsonpath='{.status.conditions[?(@.type=="Ready")].status}'
      register: node_ready
      until: node_ready.stdout == "True"
      retries: 30
      delay: 10
      delegate_to: k3s-bastion-01
      environment:
        KUBECONFIG: "{{ kubeconfig_path }}"
      when: reboot_required_file.stat.exists
      changed_when: false
      tags:
        - reboot
        - verify

    - name: Display completion status
      ansible.builtin.debug:
        msg: "{{ inventory_hostname }}: {{ 'Rebooted successfully and back in cluster' if reboot_required_file.stat.exists else 'No reboot needed' }}"
      tags:
        - reboot

- name: Reboot Bastion Node
  hosts: k3s_bastion
  gather_facts: false
  become: true

  tasks:
    - name: Check if reboot is required
      ansible.builtin.stat:
        path: /var/run/reboot-required
      register: reboot_required_file
      tags:
        - reboot
        - check

    - name: Display reboot status
      ansible.builtin.debug:
        msg: "{{ inventory_hostname }}: Reboot {{ 'REQUIRED' if reboot_required_file.stat.exists else 'NOT REQUIRED' }}"
      tags:
        - reboot
        - check

    - name: Reboot the bastion
      ansible.builtin.reboot:
        reboot_timeout: 600
        msg: "Rebooting {{ inventory_hostname }} for system updates"
        pre_reboot_delay: 5
        post_reboot_delay: 30
      when: reboot_required_file.stat.exists
      tags:
        - reboot

    - name: Wait for bastion to come back online
      ansible.builtin.wait_for_connection:
        timeout: 300
        delay: 10
      when: reboot_required_file.stat.exists
      tags:
        - reboot

    - name: Verify bastion is responsive
      ansible.builtin.ping:
      when: reboot_required_file.stat.exists
      tags:
        - reboot

    - name: Display completion status
      ansible.builtin.debug:
        msg: "{{ inventory_hostname }}: {{ 'Rebooted successfully' if reboot_required_file.stat.exists else 'No reboot needed' }}"
      tags:
        - reboot
