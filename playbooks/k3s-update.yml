---
# Playbook: Update k3s cluster VMs
# Usage: ansible-playbook -i inventory/k3s-cluster.yml k3s-update.yml

- name: Update k3s Cluster Nodes
  hosts: k3s_cluster
  gather_facts: true
  become: true  # Explicitly enable privilege escalation for system updates
  serial: "{{ update_serial | default(1) }}"  # Update nodes one at a time by default

  tasks:
    - name: Update apt cache
      ansible.builtin.apt:
        update_cache: true
        cache_valid_time: "{{ update_cache_valid_time | default(3600) }}"
      tags:
        - update
        - cache

    - name: Upgrade all packages to latest version
      ansible.builtin.apt:
        upgrade: dist
        autoremove: true
        autoclean: true
      register: apt_upgrade_result
      tags:
        - update
        - upgrade

    - name: Check if reboot is required
      ansible.builtin.stat:
        path: /var/run/reboot-required
      register: reboot_required_file
      tags:
        - update
        - reboot

    - name: Display reboot requirement status
      ansible.builtin.debug:
        msg: "Reboot required: {{ reboot_required_file.stat.exists }}"
      tags:
        - update
        - reboot

    - name: Reboot if required and auto_reboot is enabled
      ansible.builtin.reboot:
        reboot_timeout: 600
        msg: "Rebooting due to system updates"
      when:
        - reboot_required_file.stat.exists
        - auto_reboot | default(false) | bool
      tags:
        - update
        - reboot

    - name: Wait for nodes to come back online
      ansible.builtin.wait_for_connection:
        timeout: 300
        delay: 10
      when:
        - reboot_required_file.stat.exists
        - auto_reboot | default(false) | bool
      tags:
        - update
        - reboot

    - name: Display update summary
      ansible.builtin.debug:
        msg:
          - "Packages updated: {{ apt_upgrade_result.changed }}"
          - "Reboot required: {{ reboot_required_file.stat.exists }}"
          - "Auto reboot: {{ auto_reboot | default(false) }}"
      tags:
        - update

- name: Update Bastion Node
  hosts: k3s_bastion
  gather_facts: true
  become: true  # Explicitly enable privilege escalation for system updates

  tasks:
    - name: Update apt cache
      ansible.builtin.apt:
        update_cache: true
        cache_valid_time: "{{ update_cache_valid_time | default(3600) }}"
      tags:
        - update
        - cache

    - name: Upgrade all packages to latest version
      ansible.builtin.apt:
        upgrade: dist
        autoremove: true
        autoclean: true
      register: apt_upgrade_result
      tags:
        - update
        - upgrade

    - name: Check if reboot is required
      ansible.builtin.stat:
        path: /var/run/reboot-required
      register: reboot_required_file
      tags:
        - update
        - reboot

    - name: Display update summary
      ansible.builtin.debug:
        msg:
          - "Packages updated: {{ apt_upgrade_result.changed }}"
          - "Reboot required: {{ reboot_required_file.stat.exists }}"
      tags:
        - update
