- name: Ensure the 'ansible' user exists
  ansible.builtin.user:
    name: ansible
    state: present
    createhome: true
- name: Check if ansible SSH key exists
  ansible.builtin.stat:
    path: "{{ lookup('env', 'HOME') }}/.ssh/ansible.pub"
  delegate_to: localhost
  register: common_ansible_ssh_key
  become: false

- name: Copy ssh key to remote host
  ansible.posix.authorized_key:
    user: ansible
    state: present
    key: "{{ lookup('file', '~/.ssh/ansible.pub') }}"
  when: common_ansible_ssh_key.stat.exists

- name: Warn if ansible SSH key is missing
  ansible.builtin.debug:
    msg: "WARNING: ~/.ssh/ansible.pub not found. Skipping key installation for ansible user."
  when: not common_ansible_ssh_key.stat.exists

- name: Make ansible a sudoer
  ansible.builtin.copy:
    src: ans
    dest: /etc/sudoers.d/ans
    mode: "0440"
    validate: /usr/sbin/visudo -csf %s
